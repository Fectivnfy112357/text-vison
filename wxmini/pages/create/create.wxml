<!--文生视界微信小程序 - 创作页面模板-->
<view class="create-container">
  <!-- 自定义导航栏 -->
  <view class="custom-navbar">
    <view class="navbar-content">
      <view class="navbar-left" bindtap="navigateBack">
        <image class="back-icon" src="/images/icons/back.png" />
      </view>
      <view class="navbar-title">
        <text wx:if="{{createType === 'image'}}">AI图片生成</text>
        <text wx:elif="{{createType === 'video'}}">AI视频生成</text>
        <text wx:else>图像转换</text>
      </view>
      <view class="navbar-right">
        <view class="help-icon" bindtap="onShowHelp">
          <image class="icon" src="/images/icons/help.png" />
        </view>
      </view>
    </view>
  </view>

  <!-- 页面内容 -->
  <scroll-view class="page-content" scroll-y="{{true}}">
    <!-- 模板信息 -->
    <view class="template-info" wx:if="{{selectedTemplate}}">
      <view class="template-card">
        <image class="template-preview" src="{{selectedTemplate.preview_image}}" mode="aspectFill" />
        <view class="template-details">
          <text class="template-name">{{selectedTemplate.name}}</text>
          <text class="template-desc">{{selectedTemplate.description}}</text>
          <view class="template-tags">
            <text class="tag" wx:for="{{selectedTemplate.tags}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 提示词输入 -->
    <view class="prompt-section">
      <view class="section-title">
        <text class="title-text">创作描述</text>
        <text class="title-required">*</text>
      </view>
      
      <view class="prompt-input-wrapper">
        <textarea 
          class="prompt-input"
          placeholder="{{promptPlaceholder}}"
          value="{{prompt}}"
          bindinput="onPromptInput"
          maxlength="500"
          auto-height="{{true}}"
          show-confirm-bar="{{false}}"
        />
        <view class="input-counter">
          <text>{{prompt.length}}/500</text>
        </view>
      </view>
      
      <!-- 提示词建议 -->
      <view class="prompt-suggestions" wx:if="{{promptSuggestions.length > 0}}">
        <text class="suggestions-title">建议词汇：</text>
        <view class="suggestions-list">
          <text 
            class="suggestion-item"
            wx:for="{{promptSuggestions}}"
            wx:key="*this"
            bindtap="onSuggestionTap"
            data-index="{{index}}"
          >
            {{item}}
          </text>
        </view>
      </view>
    </view>

    <!-- 图片上传（图生图模式） -->
    <view class="upload-section" wx:if="{{createType === 'transform'}}">
      <view class="section-title">
        <text class="title-text">上传图片</text>
        <text class="title-required">*</text>
      </view>
      
      <view class="upload-area" wx:if="{{!uploadedImage}}" bindtap="onUploadImage">
        <image class="upload-icon" src="/images/icons/upload.png" />
        <text class="upload-text">点击上传图片</text>
        <text class="upload-tips">支持JPG、PNG格式，建议尺寸512x512</text>
      </view>
      
      <view class="uploaded-image" wx:else>
        <image class="image-preview" src="{{uploadedImagePath}}" mode="aspectFill" />
        <view class="image-actions">
          <view class="action-btn" bindtap="onUploadImage">
            <image class="action-icon" src="/images/icons/replace.png" />
            <text>更换</text>
          </view>
          <view class="action-btn" bindtap="onRemoveImage">
            <image class="action-icon" src="/images/icons/delete.png" />
            <text>删除</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 基础参数 -->
    <view class="params-section">
      <view class="section-title">
        <text class="title-text">生成参数</text>
        <view class="title-action" bindtap="onToggleAdvanced">
          <text class="action-text">{{showAdvanced ? '收起' : '高级设置'}}</text>
          <image class="action-icon {{showAdvanced ? 'rotated' : ''}}" src="/images/icons/arrow-down.png" />
        </view>
      </view>
      
      <!-- 图片生成参数 -->
      <view wx:if="{{createType === 'image'}}">
        <!-- 尺寸比例 -->
        <view class="param-item">
          <text class="param-label">尺寸比例</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{sizeOptions}}"
            range-key="label"
            value="{{selectedSizeIndex}}"
            bindchange="onSizeChange"
          >
            <view class="picker-display">
              <text>{{sizeOptions[selectedSizeIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
        
        <!-- 图片质量 -->
        <view class="param-item">
          <text class="param-label">图片质量</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{qualityOptions}}"
            range-key="label"
            value="{{selectedQualityIndex}}"
            bindchange="onQualityChange"
          >
            <view class="picker-display">
              <text>{{qualityOptions[selectedQualityIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
      </view>
      
      <!-- 视频生成参数 -->
      <view wx:if="{{createType === 'video'}}">
        <!-- 视频模型 -->
        <view class="param-item">
          <text class="param-label">生成模型</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{videoModels}}"
            range-key="label"
            value="{{selectedModelIndex}}"
            bindchange="onVideoModelChange"
          >
            <view class="picker-display">
              <text>{{videoModels[selectedModelIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
        
        <!-- 视频分辨率 -->
        <view class="param-item">
          <text class="param-label">分辨率</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{resolutionOptions}}"
            range-key="label"
            value="{{selectedResolutionIndex}}"
            bindchange="onResolutionChange"
          >
            <view class="picker-display">
              <text>{{resolutionOptions[selectedResolutionIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
        
        <!-- 视频时长 -->
        <view class="param-item">
          <text class="param-label">视频时长</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{videoDurations}}"
            range-key="label"
            value="{{selectedDurationIndex}}"
            bindchange="onDurationChange"
          >
            <view class="picker-display">
              <text>{{videoDurations[selectedDurationIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
        
        <!-- 视频比例 -->
        <view class="param-item">
          <text class="param-label">视频比例</text>
          <picker 
            class="param-picker"
            mode="selector"
            range="{{videoRatios}}"
            range-key="label"
            value="{{selectedRatioIndex}}"
            bindchange="onRatioChange"
          >
            <view class="picker-display">
              <text>{{videoRatios[selectedRatioIndex].label}}</text>
              <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
            </view>
          </picker>
        </view>
      </view>
      
      <!-- 高级参数 -->
      <view class="advanced-params" wx:if="{{showAdvanced}}">
        <!-- 图片高级参数 -->
        <view wx:if="{{createType === 'image'}}">
          <!-- 随机数种子 -->
          <view class="param-item">
            <view class="param-header">
              <text class="param-label">随机数种子</text>
              <text class="param-value">{{params.seed === -1 ? '自动' : params.seed}}</text>
            </view>
            <view class="param-input-row">
              <input 
                class="param-input"
                type="number"
                placeholder="-1 (自动生成)"
                value="{{params.seed === -1 ? '' : params.seed}}"
                bindinput="onSeedInput"
              />
              <button class="param-btn" bindtap="onRandomSeed">随机</button>
            </view>
            <view class="param-tips">
              <text>控制生成结果的随机性，相同种子产生相似结果</text>
            </view>
          </view>
          
          <!-- 引导比例 -->
          <view class="param-item">
            <view class="param-header">
              <text class="param-label">引导比例</text>
              <text class="param-value">{{params.guidanceScale}}</text>
            </view>
            <slider 
              class="param-slider"
              min="1"
              max="10"
              step="0.1"
              value="{{params.guidanceScale}}"
              bindchange="onParamSliderChange"
              data-param="guidanceScale"
              activeColor="var(--color-primary)"
              backgroundColor="var(--border-color-light)"
            />
            <view class="param-tips">
              <text>控制模型输出结果与提示词的一致程度</text>
            </view>
          </view>
        </view>
        
        <!-- 视频高级参数 -->
        <view wx:if="{{createType === 'video'}}">
          <!-- 帧率 -->
          <view class="param-item">
            <text class="param-label">帧率</text>
            <picker 
              class="param-picker"
              mode="selector"
              range="{{fpsOptions}}"
              range-key="label"
              value="{{selectedFpsIndex}}"
              bindchange="onFpsChange"
            >
              <view class="picker-display">
                <text>{{fpsOptions[selectedFpsIndex].label}}</text>
                <image class="picker-arrow" src="/assets/icons/arrow-down.png" />
              </view>
            </picker>
          </view>
          
          <!-- CFG Scale -->
          <view class="param-item">
            <view class="param-header">
              <text class="param-label">CFG Scale</text>
              <text class="param-value">{{params.cfgScale}}</text>
            </view>
            <slider 
              class="param-slider"
              min="1"
              max="20"
              step="0.1"
              value="{{params.cfgScale}}"
              bindchange="onParamSliderChange"
              data-param="cfgScale"
              activeColor="var(--color-primary)"
              backgroundColor="var(--border-color-light)"
            />
            <view class="param-tips">
              <text>控制生成内容与提示词的匹配程度</text>
            </view>
          </view>
          
          <!-- 生成数量 -->
          <view class="param-item">
            <view class="param-header">
              <text class="param-label">生成数量</text>
              <text class="param-value">{{params.count}}</text>
            </view>
            <slider 
              class="param-slider"
              min="1"
              max="4"
              step="1"
              value="{{params.count}}"
              bindchange="onParamSliderChange"
              data-param="count"
              activeColor="var(--color-primary)"
              backgroundColor="var(--border-color-light)"
            />
            <view class="param-tips">
              <text>同时生成多个视频，最多4个</text>
            </view>
          </view>
          
          <!-- 摄像头设置 -->
          <view class="param-item">
            <view class="param-row">
              <text class="param-label">固定摄像头</text>
              <switch 
                class="param-switch"
                checked="{{params.cameraFixed}}"
                bindchange="onCameraFixedChange"
                color="var(--color-primary)"
              />
            </view>
            <view class="param-tips">
              <text>开启后摄像头保持静止，关闭后允许摄像头运动</text>
            </view>
          </view>
          
          <!-- 高清模式 -->
          <view class="param-item">
            <view class="param-row">
              <text class="param-label">高清模式</text>
              <switch 
                class="param-switch"
                checked="{{params.hd}}"
                bindchange="onHdChange"
                color="var(--color-primary)"
              />
            </view>
            <view class="param-tips">
              <text>启用高清模式，提升视频质量但增加生成时间</text>
            </view>
          </view>
        </view>
        
        <!-- 通用高级参数 -->
        <view class="param-item">
          <view class="param-row">
            <text class="param-label">添加水印</text>
            <switch 
              class="param-switch"
              checked="{{params.watermark}}"
              bindchange="onWatermarkChange"
              color="var(--color-primary)"
            />
          </view>
          <view class="param-tips">
            <text>在生成内容上添加平台水印</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 生成按钮 -->
    <view class="generate-section">
      <button 
        class="generate-btn {{generating ? 'generating' : ''}}"
        bindtap="onStartGenerate"
        disabled="{{generating}}"
      >
        <view wx:if="{{!generating}}" class="btn-content">
          <image class="btn-icon" src="/images/icons/magic.png" />
          <text class="btn-text">开始生成</text>
        </view>
        <view wx:else class="btn-content">
          <view class="loading-spinner"></view>
          <text class="btn-text">{{generationStatus}}</text>
        </view>
      </button>
      
      <!-- 生成进度 -->
      <view class="progress-section" wx:if="{{generating}}">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{generationProgress}}%"></view>
        </view>
        <view class="progress-text">
          <text>{{generationProgress}}%</text>
          <text class="cancel-btn" bindtap="cancelGeneration">取消</text>
        </view>
      </view>
    </view>

    <!-- 底部间距 -->
    <view class="bottom-spacing"></view>
  </scroll-view>

  <!-- 生成结果弹窗 -->
  <view class="result-modal {{showResults ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="modal-backdrop" bindtap="onCloseResults"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">生成结果</text>
        <view class="modal-close" bindtap="onCloseResults">
          <image class="close-icon" src="/images/icons/close.png" />
        </view>
      </view>
      
      <view class="modal-body">
        <!-- 结果展示 -->
        <view class="result-display" wx:if="{{generatedResults.length > 0}}">
          <swiper 
            class="result-swiper"
            indicator-dots="{{generatedResults.length > 1}}"
            indicator-color="rgba(255,255,255,0.5)"
            indicator-active-color="#ffffff"
            bindchange="onResultSwiper"
          >
            <swiper-item wx:for="{{generatedResults}}" wx:key="id">
              <view class="result-item">
                <image 
                  wx:if="{{createType !== 'video'}}"
                  class="result-image" 
                  src="{{item.url}}" 
                  mode="aspectFit"
                  bindlongpress="onSaveResult"
                />
                <video 
                  wx:else
                  class="result-video"
                  src="{{item.url}}"
                  controls="{{true}}"
                  autoplay="{{false}}"
                  loop="{{true}}"
                />
              </view>
            </swiper-item>
          </swiper>
          
          <!-- 结果信息 -->
          <view class="result-info" wx:if="{{generatedResults[currentResultIndex]}}">
            <text class="result-prompt">{{prompt}}</text>
            <view class="result-meta">
              <text class="meta-item">尺寸: {{generatedResults[currentResultIndex].width}}x{{generatedResults[currentResultIndex].height}}</text>
              <text class="meta-item" wx:if="{{createType === 'video'}}">时长: {{generatedResults[currentResultIndex].duration}}s</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="action-buttons">
          <button class="action-btn secondary" bindtap="onRegenerate">
            <image class="btn-icon" src="/images/icons/refresh.png" />
            <text>重新生成</text>
          </button>
          <button class="action-btn secondary" bindtap="onSaveResult">
            <image class="btn-icon" src="/images/icons/download.png" />
            <text>保存</text>
          </button>
          <button class="action-btn primary" bindtap="onShareResult">
            <image class="btn-icon" src="/images/icons/share.png" />
            <text>分享</text>
          </button>
        </view>
      </view>
    </view>
  </view>
</view>